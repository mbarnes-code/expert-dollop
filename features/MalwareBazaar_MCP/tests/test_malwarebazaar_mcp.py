import unittest
from unittest.mock import patch, AsyncMock
from malwarebazaar_mcp import get_info, get_file


class TestMalwareBazaarMCP(unittest.IsolatedAsyncioTestCase):
    """
    Unit tests for functions in the malwarebazaar_mcp module,
    focusing on asynchronous behaviors and response handling.
    """

    @patch("malwarebazaar_mcp.make_mb_request", new_callable=AsyncMock)
    async def test_get_info_success(self, mock_request):
        """
        Test that get_info returns expected formatted result when the
        query status is 'ok' and the response contains sample metadata.
        """
        mock_request.return_value = {
            "query_status": "ok",
            "data": [{"sha256_hash": "abc123", "first_seen": "2023-01-01"}],
        }
        result = await get_info(sha256="abc123")
        self.assertIn("abc123", result)
        self.assertIn("Malware Sample Metadata", result)
        self.assertIn("```text", result)

    @patch("malwarebazaar_mcp.make_mb_request", new_callable=AsyncMock)
    async def test_get_info_hash_not_found(self, mock_request):
        """
        Test that get_info returns an appropriate error message when
        the hash is not found in the MalwareBazaar database.
        """
        mock_request.return_value = {"query_status": "hash_not_found"}
        result = await get_info(sha256="deadbeef")
        self.assertIn("❌ Error: `hash_not_found`", result)

    @patch("malwarebazaar_mcp.make_mb_request", new_callable=AsyncMock)
    async def test_get_info_invalid_selector(self, mock_request):
        """
        Test that get_info returns an error message when the provided
        selector is invalid or unsupported.
        """
        result = await get_info(selector="invalid", sha256="")
        self.assertIn("❌ Error: `selector` is not valid", result)

    @patch("malwarebazaar_mcp.httpx.AsyncClient.post")
    async def test_get_file_success_zip(self, mock_post):
        """
        Test that get_file correctly handles a successful ZIP file response
        from MalwareBazaar, including content-type and password message.
        """
        class MockResponse:
            status_code = 200
            headers = {"content-type": "application/zip", "content-length": "12345"}
            content = b"PK...mockzipcontent..."

            def json(self):
                return {}

        mock_post.return_value = MockResponse()
        result = await get_file("abc123")
        self.assertIn("Saved to:", result)
        self.assertIn("Password: 'infected'", result)
        self.assertIn("```text", result)


if __name__ == "__main__":
    unittest.main()
